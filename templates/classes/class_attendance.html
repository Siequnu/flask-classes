{% extends "header.html" %}
{% from 'bootstrap/form.html' import render_form %}
{% from 'bootstrap/form.html' import render_field %}
{% block app_content %}


<div class="container">
  <br>
  <!-- Help modal -->
  <div class="modal fade" id="lessonCreationHelpModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <h1 class="display-5"><i class="fa fa-chalkboard-teacher"></i> Create a lesson</h1>
          <p class="lead">This form is used to create a new lesson for a selected class.</p>
          <hr class="my-4">
          <p>The lesson start and end times are set to the default for this class, but can be changed. The class sign-up
            code automatically closes at the end of the lesson time.</p>
          <p>If you have a Zoom invitation text, paste it into the Zoom lesson invitation field. The URL, meeting room
            ID and password will automatically be parsed from the invitation.</p>
          <p>If you are using an alternative service, then you can include an online lesson code and password.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" data-toggle="modal"
            data-target="#createNewLessonModal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <div class="container">
    <div class="row">
      <div class="col-md-2">
        <a href="{{url_for('classes.class_admin')}}"><button class="btn btn-light">
            <i class="fa fa-chevron-left">
            </i> Back
          </button>
        </a>
      </div>
      <div class="col-md-10">

        <h2><i class="fa fa-users"></i> Class attendance - {{turma.turma_label}}</h2>

      </div>
    </div>
    <hr>
    <div class="card bg-white mb-2" style="max-width: 25rem;">
      <div class="card-body">
        <h4><i class="fa fa-users"></i> {{turma.turma_label}}</h4>
        <h4><i class="fa fa-calendar-alt"></i> {{turma.turma_term}} {{turma.turma_year}}</h4>
      </div>
      <div class="card-footer">
        <a href="{{url_for('classes.create_lesson', class_id = turma.id)}}" class="createNewLessonModal"><button
            class="btn btn-lg btn-outline-success" data-toggle="modal" data-target="#createNewLessonModal"><i
              class="fa fa-plus-circle"></i> Create new lesson </button></a>
        <br><br>
        <!--
        <a href="{{url_for('classes.create_lesson', class_id = turma.id)}}" <button class="btn btn-lg btn-outline-primary"><i
            class="fa fa-tasks"></i> View attendance </button></a>-->
      </div>
    </div>

    <br>
    <h2>Lessons</h2>
    <br>

    {% if lessons|length == 0 %}
    <p>You haven't added any lessons for this class yet. Create a new lesson to start tracking attendance.</p>
    {% endif %}

    {% for lesson in lessons %}
    <div class="card bg-light mb-3" style="max-width: 35rem;">
      <div class="card-body">

        <div class="container">
          <div class="row">
            <div class="col-4 align-self-center">
              <h3 class="display-5">
                <span class="badge badge-secondary">
                  <i class="fa fa-user-check ">
                  </i> {{lesson.attendance_stats.attendance}} / {{lesson.attendance_stats.students_in_class}}
                </span>
              </h3>
            </div>
            <div class="col-8">
              <h5><i class="fa fa-calendar-day"></i> {{lesson.date}}</h5>
              <p><i class="fa fa-clock"></i>
                {{lesson.start_time.strftime('%H:%M')}}-{{lesson.end_time.strftime('%H:%M')}}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <a href="{{url_for('classes.open_attendance', lesson_id = lesson.id)}}"><button class="btn btn-info"><i
              class="fa fa-qrcode"></i> Take attendance </button></a>
        <a href="{{url_for('classes.view_lesson_attendance', lesson_id = lesson.id)}}"><button
            class="btn btn-outline-secondary"><i class="fa fa-user-check"></i> View attendance </button></a>
        <a href="{{url_for('classes.delete_lesson', lesson_id = lesson.id)}}"><button class="btn btn-outline-warning"><i
              class="fa fa-trash-alt"></i> Delete lesson </button></a>
      </div>
      {% if lesson.online_lesson_code %}
      <div class="card-footer">
        <div class="row">
          <div class="col-6 align-self-center">
            <h6 class="card-subtitle mt-2 text-muted text-center">{{lesson.online_lesson_code}} -
              {{lesson.online_lesson_password}}</h6>
          </div>
          <div class="col-6 align-self-right">
            <a href="{{lesson.online_lesson_url}}" target="_blank"><button class="btn btn-outline-success"><i
                  class="fa fa-phone-volume"></i> Open class in Zoom
                <i class="fa fa-chevron-right"></i></button></a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>



<!-- New lesson creation modal -->
<div class="modal fade" id="createNewLessonModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <button type="button" class="btn btn-lg btn-outline-secondary float-right" data-dismiss="modal"
          data-toggle="modal" data-target="#lessonCreationHelpModal">
          <i class="fa fa-info"></i>
        </button>
        <h1 class="display-5"><i class="fa fa-chalkboard-teacher"></i> Create a lesson</h1>
        <hr class="my-4">
        <form method="post" action="{{url_for('classes.create_lesson', class_id = turma.id)}}"
          enctype="multipart/form-data">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ render_field(form.start_time) }}
          {{ render_field(form.end_time) }}
          {{ render_field(form.online_lesson_invitation) }}
          {{ render_field(form.online_lesson_code) }}
          {{ render_field(form.online_lesson_password) }}
          {{ render_field(form.date) }}
          <button type="button" class="btn btn-light addMeetingDetails">Add online meeting details<i
              class="fa fa-chevron-down"></i></button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        {{ render_field(form.new_lesson_form_submit, button_style="success") }}
        </form>
      </div>
    </div>
  </div>
</div>


<!-- jQuery Calendar picker-->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

<!-- timePicker library -->
<script type="text/javascript" src="/static/js/lib/jquery-timepicker/jquery.timepicker.min.js"></script>
<link rel="stylesheet" href="/static/js/lib/jquery-timepicker/jquery.timepicker.min.css" />

<script>
  // Enable timepicker
  $('#start_time, #end_time').timepicker({
    'timeFormat': 'H:i',
    'minTime': '07:00am',
    'step': 15
  });

  // Enable the datefield to use UI datepicker
  $('#date').datepicker({ dateFormat: 'yy-mm-dd' });
</script>

<!-- Parse Zoom pasted invitation lead -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.35/dayjs.min.js" integrity="sha512-nG86d7fodOg4f3fZF796WwIj6WwxdWI2DCXCarXZU05/UNHzC2CHQkD6dNdj6Ahaurrbed66rsvTt6r58RQ5WA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.35/plugin/customParseFormat.min.js" integrity="sha512-HVENSZfi5gX0CYmasxVKQ3imukvv6ZJVErgR/hj3B2+XeddOc0D0juWiCVXRiqhDzEp/UGeRNvRHH+y9VLApyg==" crossorigin="anonymous"></script>
<script>dayjs.extend(window.customParseFormat.min.js)</script>

<script>
  $(function () {

    // Hide extra online lesson fields
    $('#online_lesson_code').parent().hide();
    $('#online_lesson_password').parent().hide();

    // Display them on request
    $('.addMeetingDetails').on('click', function () {
      $('#online_lesson_code').parent().slideToggle();
      $('#online_lesson_password').parent().slideToggle();
      $(this).hide('slow');
    });

    // Handler for submit
    $('#online_lesson_invitation').on('paste', function (e) {
      var pasteData = e.originalEvent.clipboardData.getData('text');
      var data = { zoomInvitation: pasteData };
      const csrftoken = Cookies.get('_csrf_token');

      fetch("{{url_for('classes.parse_zoom_invitation')}}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=utf-8',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
      }).then(res => res.json()).then(data => {
        if (!data.hasOwnProperty('error')) {
          $('#online_lesson_code').val(data.meeting_id).parent().show();
          $('#online_lesson_password').val(data.meeting_passcode).parent().show();

          var datetime_object = dayjs(data.meeting_datetime_object, 'MMM DD, YYYY hh:mm A');
          var class_date = dayjs(datetime_object).format('YYYY-MM-DD');
          $('#date').val (class_date);

          $('.addMeetingDetails').hide();
        }
      });
    });
  });
</script>

<!-- New library upload button script-->
<script>
  $('.createNewLessonModal').on('click', function (event) {
    event.preventDefault();
  });
</script>




{% endblock %}